name: Setup Terraform Backend (One-time)

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-2'

jobs:
  setup-backend:
    name: Setup S3 Backend and DynamoDB Lock
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}
      
      - name: Create S3 bucket for Terraform state
        run: |
          BUCKET_NAME="sensor-backend-terraform-state"
          REGION="${{ github.event.inputs.aws_region }}"
          
          echo "================================================"
          echo "Creating bucket: $BUCKET_NAME"
          echo "Region: $REGION"
          echo "================================================"
          
          # Try to create bucket
          echo "Attempting to create bucket..."
          if [ "$REGION" = "us-east-1" ]; then
            aws s3api create-bucket \
              --bucket $BUCKET_NAME \
              --region $REGION || echo "Bucket may already exist"
          else
            aws s3api create-bucket \
              --bucket $BUCKET_NAME \
              --region $REGION \
              --create-bucket-configuration LocationConstraint=$REGION || echo "Bucket may already exist"
          fi
          
          # Verify bucket exists
          echo "Verifying bucket exists..."
          if aws s3 ls s3://$BUCKET_NAME 2>/dev/null; then
            echo "âœ… Bucket verified: $BUCKET_NAME"
          else
            echo "âŒ Bucket verification failed!"
            echo "Listing all buckets:"
            aws s3 ls
            exit 1
          fi
          
          # Wait for bucket to be fully ready
          echo "Waiting for bucket to be ready..."
          sleep 10
          
          # Enable versioning
          echo "Enabling versioning..."
          aws s3api put-bucket-versioning \
            --bucket $BUCKET_NAME \
            --region $REGION \
            --versioning-configuration Status=Enabled
          
          echo "âœ… Versioning enabled"
          
          # Enable encryption
          aws s3api put-bucket-encryption \
            --bucket $BUCKET_NAME \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'
          
          # Block public access
          aws s3api put-public-access-block \
            --bucket $BUCKET_NAME \
            --public-access-block-configuration \
              "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          
          echo "âœ… S3 bucket created: $BUCKET_NAME"
      
      - name: Create DynamoDB table for state locking
        run: |
          TABLE_NAME="terraform-state-lock"
          
          aws dynamodb create-table \
            --table-name $TABLE_NAME \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ github.event.inputs.aws_region }} 2>/dev/null || echo "Table exists"
          
          echo "âœ… DynamoDB table created: $TABLE_NAME"
      
      - name: Summary
        run: |
          echo "ðŸŽ‰ Terraform backend setup complete!"
          echo "S3 Bucket: sensor-backend-terraform-state"
          echo "DynamoDB Table: terraform-state-lock"
          echo "Region: ${{ github.event.inputs.aws_region }}"
