<!DOCTYPE html>
<html>
<head>
    <title>Kafka Processing Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #2196F3; }
        .stat-label { color: #666; margin-top: 5px; }
        .logs-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .logs-table th, .logs-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .logs-table th { background-color: #f2f2f2; }
        .status-success { color: green; font-weight: bold; }
        .status-failed { color: red; font-weight: bold; }
        .refresh-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #1976D2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kafka Processing Monitor</h1>
        
        <button class="refresh-btn" onclick="refreshData()">Refresh Data</button>
        
        <div class="stats" id="stats">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <h2>Recent Processing Logs</h2>
        <table class="logs-table" id="logsTable">
            <thead>
                <tr>
                    <th>Test ID</th>
                    <th>User ID</th>
                    <th>Sensor Type</th>
                    <th>Processing Time (s)</th>
                    <th>Status</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody id="logsBody">
                <!-- Logs will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        const API_BASE = 'http://localhost:8005';
        let authToken = null;

        // Authentication with correct user
        async function authenticate() {
            try {
                const response = await fetch(`${API_BASE}/auth/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=Vignesh&password=redlen@9891'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    return true;
                }
            } catch (error) {
                console.error('Authentication failed:', error);
            }
            return false;
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/kafka/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
            return null;
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`${API_BASE}/kafka/logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
            return [];
        }

        function displayStats(stats) {
            const statsContainer = document.getElementById('stats');
            
            if (!stats) {
                statsContainer.innerHTML = '<div class="stat-card">Failed to load stats</div>';
                return;
            }

            const successRate = stats.total_processed > 0 ? 
                (stats.successful / stats.total_processed * 100).toFixed(1) : 0;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_processed}</div>
                    <div class="stat-label">Total Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.successful}</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${successRate}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.average_processing_time.toFixed(3)}s</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.throughput_per_second.toFixed(1)}</div>
                    <div class="stat-label">Messages/Second</div>
                </div>
            `;
        }

        function displayLogs(logs) {
            const logsBody = document.getElementById('logsBody');
            
            if (!logs || logs.length === 0) {
                logsBody.innerHTML = '<tr><td colspan="6">No logs found</td></tr>';
                return;
            }

            logsBody.innerHTML = logs.map(log => {
                let statusClass = 'status-success';
                let statusText = log.status;
                
                if (log.status.includes('failed') || log.status.includes('API_FAILED') || log.status.includes('TIMEOUT')) {
                    statusClass = 'status-failed';
                    statusText = log.status.includes('API_FAILED') ? 'API FAILED' : 
                                log.status.includes('TIMEOUT') ? 'TIMEOUT' : 'KAFKA FAILED';
                } else if (log.status === 'processed') {
                    statusText = 'KAFKA SUCCESS';
                } else if (log.status.includes('API_SUCCESS')) {
                    statusText = 'API SUCCESS (Kafka Pending)';
                }
                
                return `
                    <tr>
                        <td>${log.test_id}</td>
                        <td>${log.user_id}</td>
                        <td>${log.sensor_type}</td>
                        <td>${log.processing_time_seconds.toFixed(3)}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${new Date(log.created_at).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        async function refreshData() {
            if (!authToken) {
                const authenticated = await authenticate();
                if (!authenticated) {
                    alert('Authentication failed. Please check credentials.');
                    return;
                }
            }

            const [stats, logs] = await Promise.all([
                fetchStats(),
                fetchLogs()
            ]);

            displayStats(stats);
            displayLogs(logs);
        }

        // Auto-refresh every 5 seconds
        setInterval(refreshData, 5000);

        // Initial load
        refreshData();
    </script>
</body>
</html>