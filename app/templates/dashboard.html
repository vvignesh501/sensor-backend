<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Backend Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .metric-number { font-size: 2.5em; font-weight: bold; color: #3498db; }
        .metric-label { color: #666; margin-top: 10px; }
        .test-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .test-btn { background: #e74c3c; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 5px; cursor: pointer; margin: 10px; }
        .test-btn:hover { background: #c0392b; }
        .orders-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px; }
        .order-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status.pending { background: #f39c12; color: white; }
        .status.processed { background: #27ae60; color: white; }
        table { margin-top: 15px; }
        th { font-weight: bold; text-align: left; }
        .login-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 400px; margin: 50px auto; }
        .form-group { margin-bottom: 15px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; width: 100%; }
        .btn:hover { background: #2980b9; }
        .hidden { display: none; }
        .error { color: #e74c3c; margin-top: 10px; }
        .success { color: #27ae60; margin-top: 10px; }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginSection" class="login-form">
        <h2>Login to Dashboard</h2>
        <div class="form-group">
            <input type="text" id="username" placeholder="Username" required>
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="Password" required>
        </div>
        <button class="btn" onclick="login()">Login</button>
        <div id="loginError" class="error"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardSection" class="container hidden">
        <div class="header">
            <h1>Sensor Backend Dashboard</h1>
            <p>Real-time monitoring and testing interface</p>
            <button style="float: right; background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;" onclick="logout()">Logout</button>
        </div>

        <div class="metrics">
            <div class="metric-card">
                <div class="metric-number" id="totalOrders">0</div>
                <div class="metric-label">Total Orders</div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="sensorsTested">0</div>
                <div class="metric-label">Sensors Tested</div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="anomaliesDetected">0</div>
                <div class="metric-label">Anomalies Detected</div>
            </div>
        </div>

        <div class="test-section">
            <h2>Sensor Testing</h2>
            <p>Test MM sensor type functionality</p>
            <button class="test-btn" onclick="testSensor()">üî¨ Test MM Sensor</button>
            <div id="testResult" style="margin-top: 20px;"></div>
        </div>

        <div class="orders-list">
            <h3>Recent Orders</h3>
            <div id="ordersList"></div>
        </div>

        <div class="orders-list">
            <h3>üöÄ Kafka Processing Dashboard</h3>
            <div class="metrics" style="margin: 20px 0;">
                <div class="metric-card">
                    <div class="metric-number" id="kafkaSent">0</div>
                    <div class="metric-label">Kafka Messages Sent</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="kafkaSuccessRate">0%</div>
                    <div class="metric-label">Kafka Success Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="dbProcessed">0</div>
                    <div class="metric-label">DB Records Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="dbSuccessRate">0%</div>
                    <div class="metric-label">DB Success Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="throughput">0/min</div>
                    <div class="metric-label">DB Throughput</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="cacheHits">0</div>
                    <div class="metric-label">Auth Cache Hits</div>
                </div>
            </div>
            
            <div style="margin: 15px 0; text-align: center;">
                <button class="test-btn" onclick="runLoadTest(100)" style="background: #27ae60;">üî• Run 100 Load Test</button>
                <button class="test-btn" onclick="runLoadTest(1000)" style="background: #8e44ad;">üöÄ Run 1000 Load Test</button>
                <button id="stopTestBtn" class="test-btn" onclick="stopLoadTest()" style="background: #e74c3c; display: none;">‚èπÔ∏è Stop Test</button>
                <button class="test-btn" onclick="clearKafkaLogs()" style="background: #e67e22;">üóëÔ∏è Clear Logs</button>
                <button class="test-btn" onclick="clearS3Bucket()" style="background: #c0392b;">üóëÔ∏è Clear S3</button>
                <button class="test-btn" onclick="countS3Objects()" style="background: #3498db;">üìä Count S3</button>
                <span id="lastUpdate" style="margin-left: 20px; color: #666;"></span>
            </div>
            
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Test ID</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">User</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Sensor Type</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Processing Time (s)</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Timestamp</th>
                    </tr>
                </thead>
                <tbody id="kafkaLogsList">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Auto-detect API base URL - try different ports
        const API_BASE = window.location.hostname === 'localhost' ? 
            (window.location.port === '63342' ? 'http://localhost:8000' : `http://${window.location.hostname}:8000`) :
            'http://localhost:8000';
        let authToken = '';

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE}/auth/token`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'Invalid credentials';
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Login failed: ' + error.message;
            }
        }

        function logout() {
            authToken = '';
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/metrics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalOrders').textContent = data.total_orders;
                    document.getElementById('sensorsTested').textContent = data.sensors_tested;
                    document.getElementById('anomaliesDetected').textContent = data.anomalies_detected;
                    
                    const ordersList = document.getElementById('ordersList');
                    ordersList.innerHTML = '';
                    
                    data.recent_orders.forEach(order => {
                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'order-item';
                        orderDiv.innerHTML = `
                            <div>
                                <strong>${order.sensor_type}</strong> - Qty: ${order.quantity}
                                <br><small>Customer: ${order.customer_id}</small>
                            </div>
                            <div>
                                <span class="status ${order.status}">${order.status}</span>
                            </div>
                        `;
                        ordersList.appendChild(orderDiv);
                    });
                }
                
                // Load Kafka real-time stats
                console.log('Loading dashboard - calling Kafka functions');
                await loadKafkaStats();
                await loadKafkaLogs();
                
                // Force initial update
                setTimeout(() => {
                    loadKafkaStats();
                    loadKafkaLogs();
                }, 2000);
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function testSensor() {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<div style="color: #f39c12;">üîÑ Testing MM sensor and generating raw data...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/test/sensor/MM`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const testData = await response.json();
                    
                    testResult.innerHTML = `
                        <div style="color: #27ae60; padding: 15px; background: #d5f4e6; border-radius: 5px;">
                            ‚úÖ <strong>MM Sensor Test Complete</strong><br>
                            Status: ${testData.status}<br>
                            Test ID: ${testData.test_id}<br>
                            Temperature: ${testData.test_metrics.temperature}<br>
                            Humidity: ${testData.test_metrics.humidity}<br>
                            Raw Data: ${testData.raw_data_stats.total_size_mb}MB stored in S3<br>
                            Arrays: ${testData.raw_data_stats.total_arrays} (Dynamic, Uniformity, Stability)<br>
                            Time: ${new Date(testData.timestamp).toLocaleString()}
                        </div>
                    `;
                } else {
                    testResult.innerHTML = '<div style="color: #e74c3c;">‚ùå Sensor test failed</div>';
                }
                
                // Refresh dashboard after test
                setTimeout(loadDashboard, 1000);
                
            } catch (error) {
                testResult.innerHTML = `<div style="color: #e74c3c;">‚ùå Sensor test failed: ${error.message}</div>`;
            }
        }

        async function loadKafkaStats() {
            try {
                console.log('Loading Kafka stats...');
                
                // Get producer stats
                const statsResponse = await fetch(`${API_BASE}/kafka/producer-stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    console.log('Producer stats:', stats);
                    document.getElementById('kafkaSent').textContent = stats.total_processed || 0;
                    document.getElementById('kafkaSuccessRate').textContent = `${stats.success_rate || 0}%`;
                } else {
                    console.error('Failed to fetch producer stats:', statsResponse.status);
                }

                // Get real-time stats
                const realTimeResponse = await fetch(`${API_BASE}/kafka/real-time`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (realTimeResponse.ok) {
                    const data = await realTimeResponse.json();
                    console.log('Real-time stats:', data);
                    document.getElementById('dbProcessed').textContent = data.database_consumer.recent_processed || 0;
                    document.getElementById('dbSuccessRate').textContent = `${(data.database_consumer.success_rate || 0).toFixed(1)}%`;
                    document.getElementById('throughput').textContent = `${(data.database_consumer.throughput_per_minute || 0).toFixed(1)}/min`;
                } else {
                    console.error('Failed to fetch real-time stats:', realTimeResponse.status);
                }
                
                // Get cache stats
                const cacheResponse = await fetch(`${API_BASE}/cache/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    const totalCacheHits = (cacheData.token_cache.active_tokens || 0) + (cacheData.user_cache.active_users || 0);
                    document.getElementById('cacheHits').textContent = totalCacheHits;
                }
                
                document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error loading Kafka stats:', error);
            }
        }

        let loadTestInterval;
        let loadTestRunning = false;
        let loadTestController;
        
        async function runLoadTest(count = 100) {
            const button = event.target;
            const stopButton = document.getElementById('stopTestBtn');
            
            if (loadTestRunning) return;
            
            loadTestRunning = true;
            loadTestController = new AbortController();
            
            // Hide all load test buttons
            document.querySelectorAll('[onclick*="runLoadTest"]').forEach(btn => btn.style.display = 'none');
            stopButton.style.display = 'inline-block';
            stopButton.textContent = `‚èπÔ∏è Stop Test (${count} running)`;
            
            // Start aggressive real-time updates every 1 second during load test
            loadTestInterval = setInterval(() => {
                loadKafkaStats();
                loadKafkaLogs();
            }, 1000);
            
            try {
                const tasks = [];
                for (let i = 0; i < count; i++) {
                    tasks.push(fetch(`${API_BASE}/test/sensor/MM`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        signal: loadTestController.signal
                    }));
                }
                
                const startTime = Date.now();
                const results = await Promise.allSettled(tasks);
                const endTime = Date.now();
                
                const successful = results.filter(r => r.status === 'fulfilled' && r.value && r.value.ok).length;
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                if (!loadTestController.signal.aborted) {
                    alert(`‚úÖ Load Test Complete!\n\nResults:\n- ${successful}/${count} successful\n- Duration: ${duration}s\n- Rate: ${(count/duration).toFixed(1)} req/s\n\nCheck dashboard for real-time processing!`);
                }
                
            } catch (error) {
                if (!loadTestController.signal.aborted) {
                    alert(`‚ùå Load test failed: ${error.message}`);
                }
            } finally {
                stopLoadTest();
            }
        }
        
        function stopLoadTest() {
            const stopButton = document.getElementById('stopTestBtn');
            
            loadTestRunning = false;
            
            if (loadTestController) {
                loadTestController.abort();
            }
            
            // Stop real-time updates
            clearInterval(loadTestInterval);
            
            // Final refresh
            loadDashboard();
            
            // Show all load test buttons
            document.querySelectorAll('[onclick*="runLoadTest"]').forEach(btn => btn.style.display = 'inline-block');
            stopButton.style.display = 'none';
            stopButton.textContent = '‚èπÔ∏è Stop Test';
        }

        async function clearKafkaLogs() {
            const choice = prompt('Clear logs:\n0 = Clear all\n50 = Keep recent 50\n100 = Keep recent 100\nEnter number:', '50');
            
            if (choice !== null) {
                try {
                    const keepRecent = parseInt(choice) || 0;
                    const response = await fetch(`${API_BASE}/kafka/clear-logs?keep_recent=${keepRecent}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ ${result.status}`);
                        loadDashboard();
                    }
                } catch (error) {
                    alert('‚ùå Failed to clear logs');
                }
            }
        }

        async function clearS3Bucket() {
            const confirmed = confirm('‚ö†Ô∏è WARNING: This will delete ALL files from the S3 bucket!\n\nAre you sure you want to continue?');
            
            if (confirmed) {
                try {
                    const response = await fetch(`${API_BASE}/s3/clear-bucket`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ ${result.message}\nDeleted ${result.deleted_count} objects`);
                    } else {
                        const error = await response.json();
                        alert(`‚ùå Failed to clear S3: ${error.detail}`);
                    }
                } catch (error) {
                    alert(`‚ùå Failed to clear S3: ${error.message}`);
                }
            }
        }

        async function countS3Objects() {
            try {
                const response = await fetch(`${API_BASE}/s3/count-objects`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`üìä S3 Bucket: ${result.bucket}\nTotal Objects: ${result.total_objects}`);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Failed to count S3 objects: ${error.detail}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to count S3 objects: ${error.message}`);
            }
        }

        async function loadKafkaLogs() {
            try {
                const kafkaResponse = await fetch(`${API_BASE}/kafka/producer-logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (kafkaResponse.ok) {
                    const kafkaData = await kafkaResponse.json();
                    const kafkaLogsList = document.getElementById('kafkaLogsList');
                    kafkaLogsList.innerHTML = '';
                    
                    if (kafkaData.kafka_processing_logs && kafkaData.kafka_processing_logs.length > 0) {
                        kafkaData.kafka_processing_logs.reverse().forEach(log => {
                            const row = document.createElement('tr');
                            const statusClass = log.status.includes('Success') ? 'processed' : 'pending';
                            const statusText = log.status.includes('Success') ? 'SUCCESS' : 'FAILED';
                            const processingTime = parseFloat(log.processing_time).toFixed(3);
                            
                            row.innerHTML = `
                                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${log.test_id.substring(0, 12)}...</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${log.user}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #2c3e50;">${log.sensor_type}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #e74c3c;">${processingTime}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <span class="status ${statusClass}">${statusText}</span>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-size: 12px;">${new Date(log.timestamp).toLocaleString()}</td>
                            `;
                            kafkaLogsList.appendChild(row);
                        });
                    } else {
                        kafkaLogsList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">üîÑ No Kafka processing logs yet. Run a test to see real-time data!</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading Kafka logs:', error);
            }
        }

        // Auto-refresh dashboard every 5 seconds for real-time updates
        let autoRefreshInterval = setInterval(() => {
            if (authToken && !loadTestRunning) {
                console.log('Auto-refreshing Kafka data...');
                loadKafkaStats();
                loadKafkaLogs();
            }
        }, 5000);
        
        // Initial load when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, starting auto-refresh');
        });
    </script>
</body>
</html>